---

### **MongoDB Aggregation Framework 개념 종합 설명**

Aggregation Framework를 이해하기 위해 가장 좋은 비유는 **'데이터 공장'**입니다. 여러분은 공장장이고, 컬렉션에 쌓인 데이터는 '원자재'입니다. 이 원자재를 그대로 사용할 수는 없으니, 여러 기계(공정)를 거쳐 우리가 원하는 '완제품(통계 데이터)'으로 만들어야 합니다. 이 전체 공정 라인을 **파이프라인(Pipeline)**이라고 부릅니다.

이 공장에는 세 가지 핵심 구성 요소가 있습니다.

1.  **파이프라인 (Pipeline)**: 전체 공정 라인
2.  **스테이지 (Stage)**: 라인 위의 개별 기계
3.  **연산자 (Operator)**: 각 기계 안에서 실제 작업을 하는 도구들

이제 각각을 자세히 살펴보겠습니다.

---

### **1. 파이프라인 (Pipeline) 이란?**

**개념**:
파이프라인은 **데이터 처리 단계(Stage)들의 연속적인 흐름**을 의미합니다. 원본 데이터가 첫 번째 단계를 통과하면 그 결과물이 다음 단계의 입력으로 들어가고, 이 과정이 마지막 단계까지 순차적으로 이어지는 구조입니다.

`db.collection.aggregate([ ... ])`에서 `[ ]` 배열 자체가 바로 파이프라인을 의미합니다. 이 배열 안에 스테이지들을 순서대로 넣어주는 것이죠.

**핵심 특징**:

- **순서가 생명이다**: 파이프라인에서는 스테이지의 순서가 결과에 결정적인 영향을 미칩니다. 예를 들어, 데이터를 거르고(`$match`) 그룹화(`$group`)하는 것과, 그룹화한 뒤에 거르는 것은 완전히 다른 결과를 낳습니다. **항상 데이터를 먼저 줄이고 시작하는 것(`$match`를 앞에 두는 것)이 성능에 유리합니다.**
- **데이터의 흐름**: 데이터는 파이프처럼 한 방향으로만 흐릅니다. `[컬렉션] -> [스테이지 1] -> [스테이지 2] -> ... -> [최종 결과]`
- **서버 내 처리**: 이 모든 과정은 MongoDB 서버 내부에서 직접 처리됩니다. 수십억 개의 데이터를 애플리케이션으로 가져와서 가공하는 것이 아니라, 데이터가 있는 곳에서 직접 계산하므로 매우 빠르고 효율적입니다.

**예시 시나리오**: "아시아 지역의 노트북 판매 기록만 모아서(`$match`), 월별로 총 판매액을 계산한 뒤(`$group`), 가장 많이 팔린 달 순서로 정렬(`$sort`)한다." 이 문장 자체가 하나의 파이프라인을 설명하는 것입니다.

---

### **2. 스테이지 (Stage) 란?**

**개념**:
스테이지는 파이프라인을 구성하는 **개별 데이터 처리 단위**입니다. 공장의 컨베이어 벨트 위에 놓인 각각의 기계라고 생각하면 됩니다. 각 스테이지는 `$match`, `$group`처럼 `$`로 시작하는 고유한 이름을 가지며, 한 가지의 명확한 역할을 수행합니다.

ch5 코드에 등장하는 거의 모든 `$명령어`가 바로 스테이지입니다.

**주요 스테이지의 역할별 분류**:

| 분류                  | 역할                                              | 대표적인 스테이지                                              |
| :-------------------- | :------------------------------------------------ | :------------------------------------------------------------- |
| **필터링 및 선별**    | 파이프라인을 통과할 문서를 선택하거나 개수를 조절 | `$match`, `$limit`, `$skip`, `$sample`                         |
| **데이터 형태 변형**  | 문서의 구조(모양)를 변경                          | `$project`, `$addFields`, `$replaceRoot`                       |
| **그룹화 및 집계**    | 여러 문서를 요약하여 통계를 생성                  | `$group`, `$bucket`, `$count`                                  |
| **배열 처리**         | 문서 내 배열 데이터를 처리                        | `$unwind`                                                      |
| **데이터 결합**       | 다른 컬렉션의 데이터를 합침                       | `$lookup`                                                      |
| **정렬 및 순서 지정** | 문서의 순서를 정렬                                | `$sort`                                                        |
| **결과 저장**         | 파이프라인의 결과를 다른 곳에 저장                | `$out`, `$merge`                                               |
| **특수 목적**         | 특정 도메인의 문제를 해결                         | `$geoNear` (위치), `$text` (텍스트 검색), `$facet` (다중 분석) |

---

### **3. 연산자 (Operator) 란?**

**개념**:
연산자는 스테이지 **내부에서 실제 계산이나 데이터 조작을 수행하는 함수(도구)**입니다. 스테이지가 '무엇을 할지'를 정의한다면, 연산자는 '어떻게 할지'를 구체화합니다.

예를 들어, `$group` 스테이지(기계)에게 "그룹별로 합계를 내라"고 지시할 때, '합계'를 계산하는 실제 도구가 바로 `$sum` 연산자입니다.

**주요 연산자의 종류**:

#### **가. 집계 연산자 (Accumulators)**

주로 `$group` 스테이지에서 여러 문서의 값을 하나로 합치는 데 사용됩니다.

- `$sum`: 숫자 값을 모두 더합니다. (예: 총 판매액)
- `$avg`: 숫자 값의 평균을 계산합니다. (예: 평균 평점)
- `$max` / `$min`: 최대/최소값을 찾습니다. (예: 최고 판매가)
- `$push`: 그룹에 속한 문서들의 특정 필드 값을 배열로 만듭니다. (예: 한 카테고리에 속한 모든 상품명 목록)
- `$addToSet`: `$push`와 비슷하지만, 중복된 값은 배열에 추가하지 않습니다. (예: 특정 상품을 구매한 모든 사용자 ID 목록 - 중복 제거)
- `$first` / `$last`: 정렬된 그룹에서 첫 번째/마지막 값을 가져옵니다.

**코드 예시**:

```javascript
// product별로 그룹화하여,
// amount는 모두 더하고(totalSales),
// region 값들은 중복 없이 배열로 모은다(regions).
{
  $group: {
    _id: "$product",
    totalSales: { $sum: "$amount" },
    regions: { $addToSet: "$region" }
  }
}
```

#### **나. 표현식 연산자 (Expressions)**

`$project`, `$addFields` 등 여러 스테이지에서 문서별로 값을 변환하거나 계산하는 데 사용됩니다.

- **산술 연산자**:
  - `$add`, `$subtract`, `$multiply`, `$divide`: 더하기, 빼기, 곱하기, 나누기
- **문자열 연산자**:
  - `$concat`: 여러 문자열을 하나로 합칩니다. (예: `firstName`과 `lastName` 합치기)
  - `$substrCP`: 문자열의 일부를 잘라냅니다.
  - `$toUpper` / `$toLower`: 대/소문자로 변환합니다.
- **날짜 연산자**:
  - `$year`, `$month`, `$dayOfMonth`, `$hour`: 날짜 데이터에서 특정 부분을 추출합니다. (예: ISODate에서 '연도'만 뽑아내기)
- **배열 연산자**:
  - `$size`: 배열의 요소 개수를 반환합니다.
  - `$arrayElemAt`: 배열의 특정 인덱스에 있는 요소를 가져옵니다.
- **조건부 연산자**:
  - `$cond`: `if-then-else` 논리를 제공합니다. (예: `if (score > 90) then "A" else "B"`)
- **논리 연산자**:
  - `$and`, `$or`, `$not`: 여러 조건을 조합합니다.
- **비교 연산자**:
  - `$eq` (같다), `$gt` (크다), `$lt` (작다), `$gte` (크거나 같다), `$lte` (작거나 같다)

**코드 예시**:

```javascript
// 새로운 필드 'salePrice'를 추가하는데,
// 만약 amount가 1000 이상이면 10% 할인하고, 아니면 그대로 둔다.
{
  $addFields: {
    salePrice: {
      $cond: {
        if: { $gte: ["$amount", 1000] },
        then: { $multiply: ["$amount", 0.9] },
        else: "$amount"
      }
    }
  }
}
```

### **요약 정리**

- **Aggregation Framework**: MongoDB의 강력한 데이터 분석 도구 (데이터 공장).
- **파이프라인**: 데이터 처리 단계들의 순차적인 흐름 (전체 공정 라인).
- **스테이지**: 파이프라인의 각 처리 단위 (`$match`, `$group` 등, 개별 기계).
- **연산자**: 스테이지 내에서 실제 계산을 담당하는 함수 (`$sum`, `$multiply` 등, 기계의 도구).

이 세 가지 개념의 관계와 역할을 이해하면, ch5 코드에 나열된 수많은 스테이지와 연산자들이 왜 필요하고 어떻게 서로 조합하여 강력한 데이터 분석 파이프라인을 만드는지 명확하게 파악할 수 있습니다.
